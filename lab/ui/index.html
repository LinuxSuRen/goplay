<html>
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script type="application/javascript">
        function createAudio(src, parent) {
            const source = $(document.createElement('source'))
            source.attr('src', src)
            source.attr('type', 'audio/x-m4a')

            const audio = $(document.createElement('audio'))
            audio.attr('controls','')
            audio.append(source)
            parent.append(audio)
            return audio
        }

        $.getJSON('/episodes', function (episodes){
            $.each(episodes, function (i, episode){
                const zone = $(document.createElement('div'))
                zone.attr('id', episode.metadata.name)
                zone.attr('src', episode.spec.audioSource)
                zone.append($('<span>' + episode.spec.title + '</span><br/>'))
                zone.on('play-audio', function (){
                    const audioZone = $(this)
                    createAudio(audioZone.attr('src'), audioZone).trigger('play').on('ended', function (){
                        const audioPanel = $(this)
                        const episode = audioPanel.parent().attr('id')
                        $.post('/profile/playOver?name=profile-sample&episode=' + episode, function (){
                            audioZone.trigger('ended-audio')
                        })
                    });

                    $(this).trigger('ready')
                })

                $("#episodes").append(zone)
            })

            $.getJSON('/profiles', function (profiles){
                $.each(profiles, function (i, profile) {
                    setLaterPlayButtons(profile)
                })
            })
        })

        $.getJSON('/rsses', function (rsses){
            $.each(rsses, function (i, rss){
                if(rss.spec.image) {
                    $('#rss_list').append($('<div><a href="' + rss.spec.link + '"><img width="150px" src="' + rss.spec.image + '"></a></div>'))
                } else if(rss.spec.title) {
                    $('#rss_list').append($('<div><a href="' + rss.spec.link + '">' + rss.spec.title + '</a></div>'))
                }
            })
        })

        $.getJSON('/profiles', function (profiles){
            $.each(profiles, function (i, profile) {
                const profileZone = $(document.createElement('div'))
                profileZone.append($('<span>' + profile.spec.displayName + ': </span>'))
                $.each(profile.spec.socialLinks, function (key, val) {
                    profileZone.append($('<div>' + key + ': <a target="_blank" href="https://github.com/' + val + '">' + val + '</a></div>'))
                })

                const lasterPlayListZone = $('<div><span>Listen Later List: </span></div>')
                $.each(profile.spec.laterPlayList, function (i, item){
                    lasterPlayListZone.append($('<span episode="' + item.name + '">' + item.name + '</span>'))
                })
                lasterPlayListZone.append($('<button>Play</button>'))

                profileZone.append(lasterPlayListZone)
                $('#profiles').append(profileZone)
            })

            $('button').click(function (){
                const playButton = $(this)
                playButton.parent().find('span').each(function (i, item){
                    item = $(item)
                    if(item.attr('episode') && item.attr('episode') != "") {
                        const selector = '#' + item.attr('episode')
                        $('#' + item.attr('episode')).trigger('play-audio').on('ready', function (){
                            console.log('ready' + $(this).attr('id'))
                        }).on('ended-audio', function () {
                            item.remove()
                            playButton.click()
                        })

                        $([document.documentElement, document.body]).animate({
                            scrollTop: $(selector).offset().top
                        }, 2000);
                        return false
                    }
                })
            });
        })

        function setLaterPlayButtons(profile){
            $('#episodes > div').each(function (){
                var id = $(this).attr('id')
                var found = false
                if(id != ""){
                    $.each(profile.spec.laterPlayList, function (i, item){
                        if(item.name === id){
                            found = true
                            return false
                        }
                    })
                }

                if(!found){
                    $(this).append("<button action='later' episode='" + id + "'>Listen Later</button>")
                }
            })

            $('[action="later"]').click(function (){
                const laterButton = $(this)
                // TODO read it from somewhere later
                $.post("/profile/playLater?name=profile-sample&episode=" + $(this).attr('episode'), function () {
                    laterButton.remove()
                })
            })
        }
    </script>
    <style>
        #episodes > div {
            border-style: solid;
            margin-top: 15px;
        }
        #profiles > div {
            /*border-style: solid;*/
            margin: 15px;
            padding: 5px;
        }
        #profiles > div > * {
            margin: 5px;
        }
        #rss_list > div {
            display: inline-block;
        }
        #rss_list > div:nth-child(odd) {
            width:calc(30% - 150px);
        }
        #rss_list > div:nth-child(even) {
            width:calc(30% - 150px);
        }
        audio {
            width: 100%;
        }
        span[episode] {
            margin-right: 15px;
        }
    </style>
</head>
<body>

<a class="github-fork-ribbon" target="_blank" href="https://github.com/linuxsuren/goplay"
   data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>

<div id="profiles"></div>

<div id="rss_list">
    <form action="/rsses" method="post">
        <table>
            <tr>
                <td>RSS:</td>
                <td><input name="address" type="text"></td>
            </tr>
            <tr>
                <td>Name:</td>
                <td><input name="name" type="text"></td>
            </tr>
            <tr>
                <td><input type="submit" value="Submit"></td>
            </tr>
        </table>
    </form>
</div>
<div id="episodes"></div>

</body>
</html>