<html>
<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script type="application/javascript">
        $.getJSON('/episodes', function (episodes){
            $.each(episodes, function (i, episode){
                const source = $(document.createElement('source'))
                source.attr('src', episode.spec.audioSource)
                source.attr('type', 'audio/x-m4a')

                const audio = $(document.createElement('audio'))
                audio.attr('controls','')
                audio.append(source)

                const zone = $(document.createElement('div'))
                zone.attr('id', episode.metadata.name)
                zone.append($('<span>' + episode.spec.title + '</span><br/>'))
                zone.append(audio)

                $("#episodes").append(zone)
            })

            $.getJSON('/profiles', function (profiles){
                $.each(profiles, function (i, profile) {
                    setLaterPlayButtons(profile)
                })
            })
        })

        $.getJSON('/rsses', function (rsses){
            $.each(rsses, function (i, rss){
                if(rss.spec.image) {
                    $('#rss_list').append($('<div><a href="' + rss.spec.link + '"><img width="150px" src="' + rss.spec.image + '"></a></div>'))
                } else {
                    $('#rss_list').append($('<div><a href="' + rss.spec.link + '">' + rss.spec.title + '</a></div>'))
                }
            })
        })

        $.getJSON('/profiles', function (profiles){
            $.each(profiles, function (i, profile) {
                const profileZone = $(document.createElement('div'))
                profileZone.append($('<span>' + profile.spec.displayName + ': </span>'))
                $.each(profile.spec.socialLinks, function (key, val) {
                    profileZone.append($('<div>' + key + ': <a target="_blank" href="https://github.com/' + val + '">' + val + '</a></div>'))
                })

                $.each(profile.spec.laterPlayList, function (i, item){
                    profileZone.append($('<span episode="' + item.name + '">' + item.name + '</span>'))
                })

                profileZone.append($('<button>Play</button>'))
                $('#profiles').append(profileZone)
            })

            $('button').click(function (){
                $(this).parent().find('span').each(function (i, item){
                    item = $(item)
                    if(item.attr('episode') && item.attr('episode') != "") {
                        const selector = '#' + item.attr('episode') + ' > audio'
                        $(selector).trigger('play')

                        $([document.documentElement, document.body]).animate({
                            scrollTop: $(selector).offset().top
                        }, 2000);
                        return false
                    }
                })
            });
        })

        function setLaterPlayButtons(profile){
            $('#episodes > div').each(function (){
                var id = $(this).attr('id')
                var found = false
                if(id != ""){
                    $.each(profile.spec.laterPlayList, function (i, item){
                        if(item.name === id){
                            found = true
                            return false
                        }
                    })
                }

                if(!found){
                    $(this).append("<button action='later' episode='" + id + "'>Later</button>")
                }
            })

            $('[action="later"]').click(function (){
                const form = $("<form method='post'></form>")
                // TODO read it from somewhere later
                form.attr('action', "/profile/playLater?name=profile-sample&episode=" + $(this).attr('episode'))
                $(document.body).append(form)
                form.submit()
            })
        }
    </script>
    <style>
        #episodes > div {
            border-style: solid;
            margin-top: 15px;
        }
        #profiles > div {
            border-style: solid;
            margin: 20px;
        }
    </style>
</head>
<body>

<div id="profiles"></div>

<div id="rss_list">
    <form action="/rsses" method="post">
        <table>
            <tr>
                <td>RSS:</td>
                <td><input name="address" type="text"></td>
            </tr>
            <tr>
                <td>Name:</td>
                <td><input name="name" type="text"></td>
            </tr>
            <tr>
                <td><input type="submit" value="Submit"></td>
            </tr>
        </table>
    </form>
</div>
<div id="episodes"></div>

</body>
</html>